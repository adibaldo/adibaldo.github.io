name: Cross-repo sync (Adi ↔ Franklin)

on:
  schedule:
    # 07:20 UTC = 03:20 America/Porto_Velho
    - cron: '20 7 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve counterpart repo
        id: cfg
        shell: bash
        run: |
          if [[ "${{ github.repository_owner }}" == "adibaldo" ]]; then
            echo "counterpart=franklinbaldo/adibaldo.github.io" >> "$GITHUB_OUTPUT"
            echo "actor_name=Adi Bot Sync" >> "$GITHUB_OUTPUT"
            echo "actor_email=260098358+adibaldo@users.noreply.github.com" >> "$GITHUB_OUTPUT"
          else
            echo "counterpart=adibaldo/adibaldo.github.io" >> "$GITHUB_OUTPUT"
            echo "actor_name=Franklin Bot Sync" >> "$GITHUB_OUTPUT"
            echo "actor_email=6721640+franklinbaldo@users.noreply.github.com" >> "$GITHUB_OUTPUT"
          fi

      - name: Fetch counterpart main
        shell: bash
        run: |
          git remote add counterpart "https://github.com/${{ steps.cfg.outputs.counterpart }}.git"
          git fetch origin main
          git fetch counterpart main

      - name: Check if sync is needed
        id: diff
        shell: bash
        run: |
          if git diff --quiet origin/main counterpart/main; then
            echo "needs_sync=false" >> "$GITHUB_OUTPUT"
          else
            echo "needs_sync=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create sync branch and merge counterpart
        if: steps.diff.outputs.needs_sync == 'true'
        shell: bash
        run: |
          set -e
          BRANCH="sync/auto-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

          git config user.name "${{ steps.cfg.outputs.actor_name }}"
          git config user.email "${{ steps.cfg.outputs.actor_email }}"

          git checkout -b "$BRANCH" origin/main
          git merge --no-ff counterpart/main -m "sync: merge ${{ steps.cfg.outputs.counterpart }}@main"
          git push origin "$BRANCH"

      - name: Open PR
        if: steps.diff.outputs.needs_sync == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "Sync automático: ${{ steps.cfg.outputs.counterpart }} → main" \
            --body "PR automática de sincronização diária entre os repositórios adibaldo/franklinbaldo."

      - name: No changes
        if: steps.diff.outputs.needs_sync != 'true'
        run: echo "Repos already in sync."